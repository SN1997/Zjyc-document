# 开具模块

## 开具制单
- 制单初始化通过额度编号`limit`,通过编号查询授信额度信息、开具制单限制、贸易背景资料配置信息查询基础信息---`ec-server`.

- 通过`limit`编号查询是否存在《智管信单担保函》、yml配置查询ocr识别和发票验真开关--`openBgEdit.js`

- 编辑初始化通过`openNo`查询保存数据、及贸易背景资料信息、《智管信单担保函》、yml配置查询ocr识别和发票验真开关

   ```json
   openDetail:{
     openDto:{},--开具详情
     bgInfoLists:--贸易背景资料
     			[ 
               {
                   bgCont:[], -- 合同信息
                   bgInv:[],  -- 发票信息
                   bgOther:[],-- 其他资料信息
                   otherDto:{  -------------------------------------
                       goodsTradeList:[],
                       realEstateList:[],
                       serviceList:[],						-- 初始化使用
                       projectTotalList :[],
                       projectSeparateList :[],
                       otherList :[],
                   },-----------------------------------------------
                   invSum:0, -- 发票总金额 初始化及校验使用
                   contSum:0,-- 合同总金额 初始化及校验使用
               }
     			]
   }
   ```

- [发票池](发票池.md) 只有保存页面显示实时数据,其余页面显示时点数据.

   - 新增校验规则: 
     - 发票唯一校验`发票号码+发票代码`,如果新增发票已经入库,则取库里面已经有的并且计算发票可用额度
   - 发票保存校验:
     - 发票总金额必须等于开具金额.
     - 发票`购买方`和`销售方`必须为开具双方的开具方和接受方
     - 如果进行发票验真,验真成功之后将返回的数据进行更新
     - 发票可用额度必须大于使用额度
     - 发票验真成功后不能修改发票金额
     - 发票可用额度不能大于票面额度

- 合同:

   - 合同保存校验:
     - 合同金额必须为数字
     - 合同总金额必须大于或等于开具总金额
     - 合同必须上传文件资料

- 其他资料信息:

   - 其他资料模块:从初始化获取其他资料信息然后通过点击<添加基础交易类型>`selTransaction`进行初始化数据分组

- 制单保存:

   - 表单校验:接受方企业需要进行全名称匹配选择将<接收方税务登记证号>存入`openDto`
   - 如果发票不需要验真提示信息
   - 代码中将进行发票金额锁定,授信占用

- 开具制单:选择<选择贸易背景上传方>修改开具方和接受方

   - 如果为开具方上传则进行如上校验,否则校验节点改至`待完善贸易背景资料`

## 开具复核

- 复核人操作: 该页面只需获取一个`利率曲线`调用接口`/ec/open/ajax/getReta`将返回值在复核通过后存入`openDto.ctArte`

## 平台方初审复审

- 只需要注意:打回修改,那方上传背景资料打回到那一方

## 开具签章

- 调用第三方服务接口,相关代码`AjaxEcSingController`,签章成之后发送站内信
- 签章成功后将发票锁定金额改为占用金额
- 开具(转让)首次签章之后生成E信切出票状态为为出票

## 注意事项

- 开具所有打回修改,交易背景上传打回到那一方 
- 作废、终止都需要回滚授信和发票锁定金额





